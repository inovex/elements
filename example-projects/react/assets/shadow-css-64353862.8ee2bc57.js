/*!
 * Crafted with â¤ by inovex GmbH
 *//**
 * @license
 * Copyright Google Inc. All Rights Reserved.
 *
 * Use of this source code is governed by an MIT-style license that can be
 * found in the LICENSE file at https://angular.io/license
 *
 * This file is a port of shadowCSS from webcomponents.js to TypeScript.
 * https://github.com/webcomponents/webcomponentsjs/blob/4efecd7e0e/src/ShadowCSS/ShadowCSS.js
 * https://github.com/angular/angular/blob/master/packages/compiler/src/shadow_css.ts
 */const b=t=>{const e=[];let o=0;return t=t.replace(/(\[[^\]]*\])/g,(n,a)=>{const r=`__ph-${o}__`;return e.push(a),o++,r}),{content:t.replace(/(:nth-[-\w]+)(\([^)]+\))/g,(n,a,r)=>{const l=`__ph-${o}__`;return e.push(r),o++,a+l}),placeholders:e}},w=(t,e)=>e.replace(/__ph-(\d+)__/g,(o,s)=>t[+s]),g="-shadowcsshost",O="-shadowcssslotted",k="-shadowcsscontext",H=")(?:\\(((?:\\([^)(]*\\)|[^)(]*)+?)\\))?([^,{]*)",P=new RegExp("("+g+H,"gim"),L=new RegExp("("+k+H,"gim"),j=new RegExp("("+O+H,"gim"),_=g+"-no-combinator",x=/-shadowcsshost-no-combinator([^\s]*)/,v=[/::shadow/g,/::content/g],N="([>\\s~+[.,{:][\\s\\S]*)?$",m=/-shadowcsshost/gim,M=/:host/gim,D=/::slotted/gim,I=/:host-context/gim,K=/\/\*\s*[\s\S]*?\*\//g,U=t=>t.replace(K,""),Y=/\/\*\s*#\s*source(Mapping)?URL=[\s\S]+?\*\//g,A=t=>t.match(Y)||[],G=/(\s*)([^;\{\}]+?)(\s*)((?:{%BLOCK%}?\s*;?)|(?:\s*;))/g,q=/([{}])/g,z=/(^.*?[^\\])??((:+)(.*)|$)/,F="{",J="}",S="%BLOCK%",$=(t,e)=>{const o=Q(t);let s=0;return o.escapedString.replace(G,(...c)=>{const n=c[2];let a="",r=c[4],l="";r&&r.startsWith("{"+S)&&(a=o.blocks[s++],r=r.substring(S.length+1),l="{");const p=e({selector:n,content:a});return`${c[1]}${p.selector}${c[3]}${l}${p.content}${r}`})},Q=t=>{const e=t.split(q),o=[],s=[];let c=0,n=[];for(let r=0;r<e.length;r++){const l=e[r];l===J&&c--,c>0?n.push(l):(n.length>0&&(s.push(n.join("")),o.push(S),n=[]),o.push(l)),l===F&&c++}return n.length>0&&(s.push(n.join("")),o.push(S)),{escapedString:o.join(""),blocks:s}},V=t=>(t=t.replace(I,k).replace(M,g).replace(D,O),t),y=(t,e,o)=>t.replace(e,(...s)=>{if(s[2]){const c=s[2].split(","),n=[];for(let a=0;a<c.length;a++){const r=c[a].trim();if(!r)break;n.push(o(_,r,s[3]))}return n.join(",")}else return _+s[3]}),B=(t,e,o)=>t+e.replace(g,"")+o,X=t=>y(t,P,B),Z=(t,e,o)=>e.indexOf(g)>-1?B(t,e,o):t+e+o+", "+e+" "+t+o,T=(t,e)=>{const o="."+e+" > ",s=[];return t=t.replace(j,(...c)=>{if(c[2]){const n=c[2].trim(),a=c[3],r=o+n+a;let l="";for(let d=c[4]-1;d>=0;d--){const u=c[5][d];if(u==="}"||u===",")break;l=u+l}const i=l+r,p=`${l.trimRight()}${r.trim()}`;if(i.trim()!==p.trim()){const d=`${p}, ${i}`;s.push({orgSelector:i,updatedSelector:d})}return r}else return _+c[3]}),{selectors:s,cssText:t}},tt=t=>y(t,L,Z),et=t=>v.reduce((e,o)=>e.replace(o," "),t),ot=t=>{const e=/\[/g,o=/\]/g;return t=t.replace(e,"\\[").replace(o,"\\]"),new RegExp("^("+t+")"+N,"m")},nt=(t,e)=>!ot(e).test(t),E=(t,e)=>t.replace(z,(o,s="",c,n="",a="")=>s+e+n+a),st=(t,e,o)=>{if(m.lastIndex=0,m.test(t)){const s=`.${o}`;return t.replace(x,(c,n)=>E(n,s)).replace(m,s+" ")}return e+" "+t},ct=(t,e,o)=>{const s=/\[is=([^\]]*)\]/g;e=e.replace(s,(f,...h)=>h[0]);const c="."+e,n=f=>{let h=f.trim();if(!h)return"";if(f.indexOf(_)>-1)h=st(f,e,o);else{const C=f.replace(m,"");C.length>0&&(h=E(C,c))}return h},a=b(t);t=a.content;let r="",l=0,i;const p=/( |>|\+|~(?!=))\s*/g;let u=!(t.indexOf(_)>-1);for(;(i=p.exec(t))!==null;){const f=i[1],h=t.slice(l,i.index).trim();u=u||h.indexOf(_)>-1,r+=`${u?n(h):h} ${f} `,l=p.lastIndex}const R=t.substring(l);return u=u||R.indexOf(_)>-1,r+=u?n(R):R,w(a.placeholders,r)},rt=(t,e,o,s)=>t.split(",").map(c=>s&&c.indexOf("."+s)>-1?c.trim():nt(c,e)?ct(c,e,o).trim():c.trim()).join(", "),W=(t,e,o,s,c)=>$(t,n=>{let a=n.selector,r=n.content;return n.selector[0]!=="@"?a=rt(n.selector,e,o,s):(n.selector.startsWith("@media")||n.selector.startsWith("@supports")||n.selector.startsWith("@page")||n.selector.startsWith("@document"))&&(r=W(n.content,e,o,s)),{selector:a.replace(/\s{2,}/g," ").trim(),content:r}}),lt=(t,e,o,s,c)=>{t=V(t),t=X(t),t=tt(t);const n=T(t,s);return t=n.cssText,t=et(t),e&&(t=W(t,e,o,s)),t=t.replace(/-shadowcsshost-no-combinator/g,`.${o}`),t=t.replace(/>\s*\*\s+([^{, ]+)/gm," $1 "),{cssText:t.trim(),slottedSelectors:n.selectors}},it=(t,e,o)=>{const s=e+"-h",c=e+"-s",n=A(t);t=U(t);const a=[];if(o){const l=i=>{const p=`/*!@___${a.length}___*/`,d=`/*!@${i.selector}*/`;return a.push({placeholder:p,comment:d}),i.selector=p+i.selector,i};t=$(t,i=>i.selector[0]!=="@"?l(i):((i.selector.startsWith("@media")||i.selector.startsWith("@supports")||i.selector.startsWith("@page")||i.selector.startsWith("@document"))&&(i.content=$(i.content,l)),i))}const r=lt(t,e,s,c);return t=[r.cssText,...n].join(`
`),o&&a.forEach(({placeholder:l,comment:i})=>{t=t.replace(l,i)}),r.slottedSelectors.forEach(l=>{t=t.replace(l.orgSelector,l.updatedSelector)}),t};export{it as scopeCss};
