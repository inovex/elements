name: Deploy Unicorn

## The unicorn is public available at elements.inovex.de/unicorn/<BRANCH-NAME>.

on:
  workflow_run:
    workflows: ["Test & Build"]
    types: [completed]
    branches-ignore: [master]

jobs:
  check-changes:
    runs-on: ubuntu-latest
    if: ${{ github.event.workflow_run.conclusion == 'success' }}
    outputs:
      hasChanges: ${{ steps.dir-check.outputs.hasChanges }}
    steps:
      - uses: actions/checkout@v3
        with:
          fetch-depth: 2
      - name: Set default output
        run: echo "::set-output name=hasChanges::false"
      - name: Get changed files
        id: changed-dirs
        uses: tj-actions/changed-files@v32
        with:
          dir_names: true
      - name: Check if storybook or elements was changed
        id: dir-check
        if: contains(join(steps.changed-dirs.outputs.all_changed_and_modified_files), 'packages/elements') ||
          contains(join(steps.changed-dirs.outputs.all_changed_and_modified_files), 'packages/storybook')
        run: echo "::set-output name=hasChanges::true"

  deploy-unicorn:
    runs-on: ubuntu-latest
    if: ${{ needs.check-changes.outputs.hasChanges == 'true' }}
    needs: check-changes
    environment:
      name: github-pages
      url: ${{ steps.set_env_id.outputs.url }}
    steps:
    - name: Download Storybook artifact
      uses: dawidd6/action-download-artifact@v2
      with:
        workflow: ${{ github.event.workflow_run.workflow_id }}
        name: storybook
        path: storybook-dist

    - name: Set environment url
      id: set_env_id
      run: echo "::set-output name=url::https://elements.inovex.de/unicorn/${{ github.event.workflow_run.head_branch  }}"

    - name: Deploy to Github Pages ðŸš€
      uses: JamesIves/github-pages-deploy-action@4
      with:
        folder: ./storybook-dist
        target-folder: unicorn/${{ github.event.workflow_run.head_branch  }}
        commit-message: Deploying unicorn ${{ github.event.workflow_run.head_branch  }} ðŸ¦„
        force: true
