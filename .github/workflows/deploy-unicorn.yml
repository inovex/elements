name: Deploy Unicorn
## The unicorn is public available at elements.inovex.de/unicorn/<BRANCH-NAME>.

on:
  workflow_call:

jobs:
  changeDetection:
    runs-on: ubuntu-latest
    outputs:
      hasChanges: ${{ steps.changed-files.outputs.any_changed || 'true' }}
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Inject slug/short variables
        uses: rlespinasse/github-slug-action@v4

      - name: Get changed files
        id: changed-files
        uses: tj-actions/changed-files@v45
        with:
          files: |
            packages/elements/**
            packages/storybook/**

  deploy:
    runs-on: ubuntu-latest
    if: ${{ needs.changeDetection.outputs.hasChanges == 'true' }}
    needs: changeDetection
    environment:
      name: github-pages
      url: https://elements.inovex.de/unicorn/${{ env.GITHUB_REF_NAME_SLUG_URL }}
    steps:
      - uses: actions/checkout@v4
        with:
          ref: pages

      - name: Inject slug/short variables
        uses: rlespinasse/github-slug-action@v4

      - name: Download Storybook artifact
        uses: actions/download-artifact@v4
        with:
          name: storybook
          path: storybook-dist

      - name: Deploy to Github Pages ðŸš€
        uses: JamesIves/github-pages-deploy-action@v4
        with:
          folder: ./storybook-dist
          target-folder: unicorn/${{ env.GITHUB_REF_NAME_SLUG_URL  }}
          commit-message: Deploying unicorn ${{ env.GITHUB_REF_NAME_SLUG_URL  }} ðŸ¦„
          force: true
